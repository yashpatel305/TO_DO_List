<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TO-DO_list</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="wrapper">
        <header class="header-bar">
            <h1>To-Do App</h1>

        </header>

        <main class="content-area">
            <section class="card entry-card">
                <h2>Add New Task</h2>
                <form id="entryForm">
                    <div class="field-group">
                        <label for="itemName">Task name</label>
                        <input id="itemName" name="name" type="text" placeholder="Task name" required />
                    </div>
                    <div class="field-group">
                        <label for="state">Status</label>
                        <select id="state" name="status">
                            <option value="Incomplete">Incomplete</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Complete">Complete</option>
                        </select>
                    </div>
                    <div class="field-group button-group">
                        <button type="submit" class="action-btn main">Create</button>
                        <button type="button" id="clearBtn" class="action-btn secondary">Reset</button>
                    </div>
                </form>
            </section>

            <section class="card view-card">
                <h2>Tasks</h2>
                <div id="messages"></div>
                <div class="data-wrapper">
                    <table id="itemsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </main>

     
    </div>

    <script>
        // Minimal client-side logic to interact with the existing Express API
        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        const tasksTableBody = $('#itemsTable tbody');
        const form = $('#entryForm');
        const alerts = $('#messages');

        function showAlert(msg, type = 'success', timeout = 2500) {
            const el = document.createElement('div');
            el.className = `alert ${type}`;
            el.textContent = msg;
            alerts.appendChild(el);
            setTimeout(() => el.classList.add('fade-out'), timeout - 500);
            setTimeout(() => el.remove(), timeout);
        }

        async function fetchTasks() {
            try {
                const res = await fetch('/tasks');
                const json = await res.json();
                return json.data || [];
            } catch (e) {
                showAlert('Failed to load tasks', 'error');
                return [];
            }
        }

        function renderTasks(tasks) {
            tasksTableBody.innerHTML = '';
            tasks.forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        ${t.id}
                    </td>
                    <td>
                        ${escapeHtml(t.name)}
                    </td>
                    <td>${escapeHtml(t.status)}</td>
                    <td class="controls-cell">
                        <button class="action-btn compact modify" data-id="${t.id}">Edit</button>
                        <button class="action-btn compact remove delete" data-id="${t.id}">Delete</button>
                    </td>
                `;
                tasksTableBody.appendChild(tr);
            });
        }

        function escapeHtml(str = '') {
            return String(str).replace(/[&<>\"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'})[s]);
        }

        async function loadAndRender() {
            const tasks = await fetchTasks();
            renderTasks(tasks);
        }

        form.addEventListener('submit', async e => {
            e.preventDefault();
            const name = $('#itemName').value.trim();
            const status = $('#state').value;
            if (!name) return showAlert('Name is required', 'error');
            try {
                const res = await fetch('/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, status })
                });
                if (!res.ok) throw new Error('Create failed');
                const json = await res.json();
                showAlert('Task created');
                form.reset();
                loadAndRender();
            } catch (err) {
                showAlert('Failed to create task', 'error');
            }
        });

        document.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('button.modify');
            const delBtn = e.target.closest('button.delete');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const name = prompt('New name:');
                if (name == null) return;
                const status = prompt('Status:', 'Incomplete') || 'Incomplete';
                try {
                    const res = await fetch(`/tasks/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, status })
                    });
                    if (!res.ok) throw new Error('Update failed');
                    showAlert('Task updated');
                    loadAndRender();
                } catch (err) {
                    showAlert('Failed to update', 'error');
                }
            }
            if (delBtn) {
                const id = delBtn.dataset.id;
                if (!confirm('Delete this task?')) return;
                try {
                    const res = await fetch(`/tasks/${id}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error('Delete failed');
                    showAlert('Task deleted');
                    loadAndRender();
                } catch (err) {
                    showAlert('Failed to delete', 'error');
                }
            }
        });

        $('#clearBtn').addEventListener('click', () => form.reset());

        // initialize
        loadAndRender();
    </script>
</body>
</html>